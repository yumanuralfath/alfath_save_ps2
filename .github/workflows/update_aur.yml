name: Update AUR pkgver

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  update-aur:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH key for AUR
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AUR_SSH_KEY }}

      - name: Add AUR to known hosts
        run: |
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -T aur@aur.archlinux.org || echo "SSH connection test completed"

      - name: Setup Arch Linux in Docker
        run: |
          docker pull archlinux:latest

      - name: Update PKGBUILD and generate SRCINFO
        run: |
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${RELEASE_TAG#v}
          echo "Updating to version: $VERSION"

          # Update pkgver in PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

          # Comment out pkgver() function if it exists to avoid conflicts
          # This is a good practice if your version is set directly from the tag
          sed -i '/^pkgver()/,/^}$/ s/^/# /' PKGBUILD

          # Run Arch container to generate SRCINFO
          # This command changes file ownership inside the workspace
          docker run --rm \
            -v $PWD:/workspace \
            -w /workspace \
            archlinux:latest \
            bash -c "
              pacman -Sy --noconfirm base-devel git
              useradd -m builder
              chown -R builder:builder /workspace
              sudo -u builder makepkg --printsrcinfo > .SRCINFO
            "

          echo "Generated .SRCINFO:"
          cat .SRCINFO

      - name: Restore workspace ownership
        run: |
          # The previous Docker step changes the owner of the workspace directory.
          # We need to change it back to the current user to allow subsequent steps
          # (like git clone) to write to the directory.
          sudo chown -R $(id -u):$(id -g) $PWD

      - name: Clone AUR repository
        run: |
          # Now this step will have the correct permissions to create the 'aur-repo' directory
          git clone ssh://aur@aur.archlinux.org/alfathsave.git aur-repo

      - name: Update AUR repository
        run: |
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${RELEASE_TAG#v}

          # Copy updated files to AUR repo
          cp PKGBUILD .SRCINFO aur-repo/

          cd aur-repo

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Check for changes and commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git add PKGBUILD .SRCINFO
            git commit -m "Update to version $VERSION"
            
            # Push changes
            git push
            echo "âœ… Successfully updated AUR package to version $VERSION"
          fi
